name: note.com è‡ªå‹•æŠ•ç¨¿

on:
  schedule:
    - cron: '0 23 * * *'  # JST 08:00
    - cron: '0 3 * * *'   # JST 12:00
    - cron: '0 9 * * *'   # JST 18:00
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  auto-post:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write  # æŠ•ç¨¿å±¥æ­´ã®git pushã«å¿…è¦

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: è¨˜äº‹ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦æŠ•ç¨¿
        env:
          # å˜ä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
          NOTE_EMAIL: ${{ secrets.NOTE_EMAIL }}
          NOTE_PASSWORD: ${{ secrets.NOTE_PASSWORD }}
          # è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆè¨­å®šã—ãŸåˆ†ã ã‘æœ‰åŠ¹ã«ãªã‚Šã¾ã™ï¼‰
          NOTE_EMAIL_1: ${{ secrets.NOTE_EMAIL_1 }}
          NOTE_PASSWORD_1: ${{ secrets.NOTE_PASSWORD_1 }}
          NOTE_EMAIL_2: ${{ secrets.NOTE_EMAIL_2 }}
          NOTE_PASSWORD_2: ${{ secrets.NOTE_PASSWORD_2 }}
          # Groq APIï¼ˆç„¡æ–™ãƒ»è¨˜äº‹ç”Ÿæˆç”¨ï¼‰
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          # Unsplash APIï¼ˆè¨˜äº‹ç”»åƒå–å¾—ç”¨ãƒ»ä»»æ„ï¼‰
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          # æŠ•ç¨¿è¨­å®š
          POST_AS_DRAFT: ${{ secrets.POST_AS_DRAFT || 'false' }}
          # é€šçŸ¥ï¼ˆæœªè¨­å®šãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LINE_NOTIFY_TOKEN: ${{ secrets.LINE_NOTIFY_TOKEN }}
        run: |
          python main.py --headless

      - name: æŠ•ç¨¿å±¥æ­´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add post_history.json thumbnails/ || true
          git diff --staged --quiet || git commit -m "ğŸ“ æŠ•ç¨¿å±¥æ­´ã‚’æ›´æ–° ($(date +'%Y-%m-%d'))"
          git push || true

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ github.run_number }}
          path: screenshots/
          retention-days: 7
